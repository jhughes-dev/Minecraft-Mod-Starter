name: Test Setup Scripts

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-bash:
    name: "Bash setup (${{ matrix.language }})"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        language: [java, kotlin]
    steps:
      - uses: actions/checkout@v4

      - name: Run setup.sh
        run: |
          chmod +x setup.sh
          printf 'testmod\nTest Mod\ncom.example.testmod\nTestAuthor\nA test mod\n${{ matrix.language }}\n' \
            | bash setup.sh --force

      - name: Verify gradle.properties
        run: |
          grep -q 'archives_base_name=testmod' gradle.properties
          grep -q 'maven_group=com.example.testmod' gradle.properties
          grep -q 'mod_name=Test Mod' gradle.properties
          grep -q 'mod_language=${{ matrix.language }}' gradle.properties

      - name: Verify Fabric API enabled
        run: grep -q '^[^/]*modApi "net.fabricmc.fabric-api:fabric-api' fabric/build.gradle

      - name: Verify Kotlin-specific settings
        if: matrix.language == 'kotlin'
        run: |
          grep -q '^kotlin_version=' gradle.properties
          test ! -f "common/src/main/java/com/example/testmod/TestmodMod.java"

      - name: Verify common assets renamed
        run: test -d "common/src/main/resources/assets/testmod"

      - name: Normalize versions in generated metadata
        run: |
          chmod +x test/normalize-versions.sh
          bash test/normalize-versions.sh fabric/src/main/resources/fabric.mod.json
          bash test/normalize-versions.sh neoforge/src/main/resources/META-INF/neoforge.mods.toml

      - name: Diff against golden files
        run: |
          LANG="${{ matrix.language }}"
          GOLDEN="test/golden/$LANG"
          FAIL=0

          diff_file() {
            if [ ! -f "$1" ]; then
              echo "::error::MISSING: $1"
              return 1
            fi
            if ! diff -u "$2" "$1"; then
              echo "::error::MISMATCH: $1 vs $2"
              return 1
            fi
          }

          if [ "$LANG" = "java" ]; then
            diff_file "common/src/main/java/com/example/testmod/TestmodMod.java" \
                       "$GOLDEN/common/src/main/java/com/example/testmod/TestmodMod.java" || FAIL=1
            diff_file "fabric/src/main/java/com/example/testmod/fabric/TestmodModFabric.java" \
                       "$GOLDEN/fabric/src/main/java/com/example/testmod/fabric/TestmodModFabric.java" || FAIL=1
            diff_file "fabric/src/main/java/com/example/testmod/mixin/package-info.java" \
                       "$GOLDEN/fabric/src/main/java/com/example/testmod/mixin/package-info.java" || FAIL=1
            diff_file "neoforge/src/main/java/com/example/testmod/neoforge/TestmodModNeoForge.java" \
                       "$GOLDEN/neoforge/src/main/java/com/example/testmod/neoforge/TestmodModNeoForge.java" || FAIL=1
          else
            diff_file "common/src/main/kotlin/com/example/testmod/TestmodMod.kt" \
                       "$GOLDEN/common/src/main/kotlin/com/example/testmod/TestmodMod.kt" || FAIL=1
            diff_file "fabric/src/main/kotlin/com/example/testmod/fabric/TestmodModFabric.kt" \
                       "$GOLDEN/fabric/src/main/kotlin/com/example/testmod/fabric/TestmodModFabric.kt" || FAIL=1
            diff_file "fabric/src/main/java/com/example/testmod/mixin/package-info.java" \
                       "$GOLDEN/fabric/src/main/java/com/example/testmod/mixin/package-info.java" || FAIL=1
            diff_file "neoforge/src/main/kotlin/com/example/testmod/neoforge/TestmodModNeoForge.kt" \
                       "$GOLDEN/neoforge/src/main/kotlin/com/example/testmod/neoforge/TestmodModNeoForge.kt" || FAIL=1
          fi

          diff_file "fabric/src/main/resources/fabric.mod.json" \
                     "$GOLDEN/fabric/src/main/resources/fabric.mod.json" || FAIL=1
          diff_file "fabric/src/main/resources/testmod.mixins.json" \
                     "$GOLDEN/fabric/src/main/resources/testmod.mixins.json" || FAIL=1
          diff_file "neoforge/src/main/resources/META-INF/neoforge.mods.toml" \
                     "$GOLDEN/neoforge/src/main/resources/META-INF/neoforge.mods.toml" || FAIL=1
          diff_file "settings.gradle" \
                     "$GOLDEN/settings.gradle" || FAIL=1

          [ "$FAIL" -eq 0 ] || exit 1
          echo "All golden file comparisons passed."

  test-powershell:
    name: "PowerShell setup (${{ matrix.language }})"
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        language: [java, kotlin]
    steps:
      - uses: actions/checkout@v4

      - name: Run setup.ps1
        shell: pwsh
        run: |
          .\setup.ps1 -ModId "testmod" -ModName "Test Mod" -Package "com.example.testmod" `
            -Author "TestAuthor" -Description "A test mod" -Language "${{ matrix.language }}" -Force

      - name: Verify gradle.properties
        shell: pwsh
        run: |
          $props = Get-Content gradle.properties -Raw
          if ($props -notmatch 'archives_base_name=testmod') { throw "Missing archives_base_name" }
          if ($props -notmatch 'maven_group=com.example.testmod') { throw "Missing maven_group" }
          if ($props -notmatch 'mod_name=Test Mod') { throw "Missing mod_name" }
          if ($props -notmatch 'mod_language=${{ matrix.language }}') { throw "Missing mod_language" }

      - name: Verify Fabric API enabled
        shell: pwsh
        run: |
          $content = Get-Content fabric/build.gradle -Raw
          if ($content -notmatch 'modApi "net.fabricmc.fabric-api:fabric-api') { throw "Fabric API not enabled" }

      - name: Verify Kotlin-specific settings
        if: matrix.language == 'kotlin'
        shell: pwsh
        run: |
          $props = Get-Content gradle.properties -Raw
          if ($props -notmatch '(?m)^kotlin_version=') { throw "kotlin_version not enabled" }
          if (Test-Path "common\src\main\java\com\example\testmod\TestmodMod.java") {
            throw "Java source not cleaned up"
          }

      - name: Verify common assets renamed
        shell: pwsh
        run: |
          if (-not (Test-Path "common\src\main\resources\assets\testmod")) { throw "Assets not renamed" }

      - name: Normalize versions in generated metadata
        shell: pwsh
        run: |
          .\test\normalize-versions.ps1 -File "fabric\src\main\resources\fabric.mod.json"
          .\test\normalize-versions.ps1 -File "neoforge\src\main\resources\META-INF\neoforge.mods.toml"

      - name: Diff against golden files
        shell: pwsh
        run: |
          $lang = "${{ matrix.language }}"
          $golden = "test/golden/$lang"
          $fail = $false

          function Compare-Golden($actual, $expected) {
            if (-not (Test-Path $actual)) {
              Write-Host "::error::MISSING: $actual"
              return $false
            }
            $a = (Get-Content $actual -Raw) -replace "`r`n", "`n"
            $e = (Get-Content $expected -Raw) -replace "`r`n", "`n"
            if ($a -ne $e) {
              Write-Host "::error::MISMATCH: $actual vs $expected"
              $aLines = $a -split "`n"
              $eLines = $e -split "`n"
              $max = [Math]::Max($aLines.Count, $eLines.Count)
              for ($i = 0; $i -lt $max; $i++) {
                $el = if ($i -lt $eLines.Count) { $eLines[$i] } else { "" }
                $al = if ($i -lt $aLines.Count) { $aLines[$i] } else { "" }
                if ($el -ne $al) {
                  Write-Host "  Line $($i+1):" -ForegroundColor Yellow
                  Write-Host "    - $el" -ForegroundColor Red
                  Write-Host "    + $al" -ForegroundColor Green
                }
              }
              return $false
            }
            return $true
          }

          if ($lang -eq "java") {
            if (-not (Compare-Golden "common/src/main/java/com/example/testmod/TestmodMod.java" `
                "$golden/common/src/main/java/com/example/testmod/TestmodMod.java")) { $fail = $true }
            if (-not (Compare-Golden "fabric/src/main/java/com/example/testmod/fabric/TestmodModFabric.java" `
                "$golden/fabric/src/main/java/com/example/testmod/fabric/TestmodModFabric.java")) { $fail = $true }
            if (-not (Compare-Golden "fabric/src/main/java/com/example/testmod/mixin/package-info.java" `
                "$golden/fabric/src/main/java/com/example/testmod/mixin/package-info.java")) { $fail = $true }
            if (-not (Compare-Golden "neoforge/src/main/java/com/example/testmod/neoforge/TestmodModNeoForge.java" `
                "$golden/neoforge/src/main/java/com/example/testmod/neoforge/TestmodModNeoForge.java")) { $fail = $true }
          } else {
            if (-not (Compare-Golden "common/src/main/kotlin/com/example/testmod/TestmodMod.kt" `
                "$golden/common/src/main/kotlin/com/example/testmod/TestmodMod.kt")) { $fail = $true }
            if (-not (Compare-Golden "fabric/src/main/kotlin/com/example/testmod/fabric/TestmodModFabric.kt" `
                "$golden/fabric/src/main/kotlin/com/example/testmod/fabric/TestmodModFabric.kt")) { $fail = $true }
            if (-not (Compare-Golden "fabric/src/main/java/com/example/testmod/mixin/package-info.java" `
                "$golden/fabric/src/main/java/com/example/testmod/mixin/package-info.java")) { $fail = $true }
            if (-not (Compare-Golden "neoforge/src/main/kotlin/com/example/testmod/neoforge/TestmodModNeoForge.kt" `
                "$golden/neoforge/src/main/kotlin/com/example/testmod/neoforge/TestmodModNeoForge.kt")) { $fail = $true }
          }

          if (-not (Compare-Golden "fabric/src/main/resources/fabric.mod.json" `
              "$golden/fabric/src/main/resources/fabric.mod.json")) { $fail = $true }
          if (-not (Compare-Golden "fabric/src/main/resources/testmod.mixins.json" `
              "$golden/fabric/src/main/resources/testmod.mixins.json")) { $fail = $true }
          if (-not (Compare-Golden "neoforge/src/main/resources/META-INF/neoforge.mods.toml" `
              "$golden/neoforge/src/main/resources/META-INF/neoforge.mods.toml")) { $fail = $true }
          if (-not (Compare-Golden "settings.gradle" `
              "$golden/settings.gradle")) { $fail = $true }

          if ($fail) { exit 1 }
          Write-Host "All golden file comparisons passed." -ForegroundColor Green
